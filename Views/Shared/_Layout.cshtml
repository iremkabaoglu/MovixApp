﻿@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager
@{
    
    var showSidebar = (ViewBag.ShowSidebar as bool?) ?? false;

    var ctrl = (string?)ViewContext.RouteData.Values["controller"] ?? "";
    var act = (string?)ViewContext.RouteData.Values["action"] ?? "";
}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"] - MovixApp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />

    
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body class="app-shell bg-dark text-light @(showSidebar ? "has-sidebar-rail" : "")">

    <!-- NAVBAR  -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom sticky-top">
        <div class="container-fluid">
            <div class="row w-100">
                <div class="col-2 d-flex align-items-center">
                    <!-- SOL: LOGO -->
                    <a class="navbar-brand d-flex align-items-center" asp-controller="Movies" asp-action="Index" aria-label="Movix">
                        <img src="~/images/logo.png" asp-append-version="true" alt="Movix" class="logo-img me-2" />

                    </a>

                </div>
                <div class="col-6 d-flex justify-content-center"></div>

                <!-- ORTA: ARAMA  -->
                <form class="nav-search mx-auto d-none d-lg-flex" method="get"
                      asp-controller="Movies" asp-action="Search" role="search" autocomplete="off">
                    <input id="navSearch" name="q" class="form-control form-control-sm"
                           type="search" placeholder="Film ara..." aria-label="Ara" />
                    <button class="btn btn-sm btn-main" type="submit">Ara</button>
                    <!-- Canlı öneri kutusu -->
                    <div id="navSuggest"
                         class="position-absolute rounded shadow bg-dark border border-secondary mt-5 d-none"
                         style="z-index:1000; min-width: 260px; max-height: 360px; overflow:auto;"></div>
                </form>
            </div>
        </div>
        <div class="col-4 d-flex justify-content-end"></div>
        <!-- SAĞ: Menü + Auth -->
        <div class="collapse navbar-collapse justify-content-end" id="navMain">
            <ul class="navbar-nav align-items-lg-center auth-actions nav-underline">

                @if (SignInManager.IsSignedIn(User))
                {
                    var user = await UserManager.GetUserAsync(User);
                    var username = user != null ? await UserManager.GetUserNameAsync(user) : "";
                    var shortName = !string.IsNullOrEmpty(username) && username.Contains("@")
                    ? username.Split('@')[0] : username;

                    <li class="nav-item dropdown">
                        <a class="btn btn-ghost btn-sm d-flex align-items-center gap-2"
                           href="#" id="userMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i>
                            <span class="d-none d-sm-inline">@shortName</span>
                            <i class="bi bi-chevron-down small"></i>
                        </a>

                        <ul class="dropdown-menu dropdown-menu-end shadow">
                            <li>
                                <a class="dropdown-item" asp-controller="Profile" asp-action="Index">
                                    <i class="bi bi-person"></i> Profil
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" asp-controller="Favorites" asp-action="Index">
                                    <i class="bi bi-heart"></i> Favorilerim
                                </a>
                            </li>

                            <li><hr class="dropdown-divider" /></li>
                            <li>
                                <form method="post" asp-area="Identity" asp-page="/Account/Logout"
                                      asp-route-returnUrl="@Url.Action("Index","Movies")">
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i class="bi bi-box-arrow-right"></i> Çıkış Yap
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </li>
                }
                else
                {
                    <li class="nav-item">
                        <a class="btn btn-ghost btn-sm ms-lg-2"
                           asp-area="Identity" asp-page="/Account/Login">
                            <i class="bi bi-box-arrow-in-right me-1"></i>
                            <span class="d-none d-sm-inline">Giriş Yap</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="btn btn-main btn-sm ms-lg-2"
                           asp-area="Identity" asp-page="/Account/Register">
                            <i class="bi bi-person-plus me-1"></i>
                            <span class="d-none d-sm-inline">Kayıt Ol</span>
                        </a>
                    </li>
                }
            </ul>

            <!-- MOBİL: Arama -->
            <form class="d-flex d-lg-none mt-2" method="get"
                  asp-controller="Movies" asp-action="Search" role="search" autocomplete="off">
                <input class="form-control form-control-sm me-2" name="q"
                       type="search" placeholder="Film ara..." />
                <button class="btn btn-main btn-sm" type="submit">Ara</button>
            </form>
        </div>

    </nav>

    <!-- SOL MENÜ (lg+) -->
    @if (showSidebar)
    {
        <aside class="sidebar-rail d-none d-lg-block">
            @await Html.PartialAsync("_SidebarGenres")
        </aside>
    }

    <!-- ANA İÇERİK -->
    <main class="content-wrap container-fluid px-3 px-lg-4 py-4 flex-fill">
        @RenderBody()
    </main>

    <!-- FOOTER -->
    <footer class="app-footer py-3 border-top border-secondary">
        <div class="container d-flex justify-content-between align-items-center small text-secondary">
            <span>&copy; @DateTime.Now.Year - MovixApp</span>
            <a class="link-light text-decoration-none" asp-controller="Home" asp-action="Privacy">Gizlilik</a>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Navbar shrink
        (function () {
            const nav = document.querySelector('.navbar-custom');
            const onScroll = () => nav && (window.scrollY > 10 ? nav.classList.add('navbar-shrink')
                                                               : nav.classList.remove('navbar-shrink'));
            onScroll(); window.addEventListener('scroll', onScroll);
        })();

        // Canlı arama önerisi
        (function () {
            const input = document.getElementById('navSearch');
            const box = document.getElementById('navSuggest');
            if (!input || !box) return;

            let timer = null;
            input.addEventListener('input', () => {
                const q = input.value.trim();
                clearTimeout(timer);

                if (q.length < 2) { box.classList.add('d-none'); box.innerHTML = ''; return; }

                timer = setTimeout(async () => {
                    try {
                        const res = await fetch(`/api/search/suggest?q=${encodeURIComponent(q)}`);
                        const items = await res.json();
                        if (!items || items.length === 0) { box.classList.add('d-none'); box.innerHTML = ''; return; }

                        box.innerHTML = items.map(m => `
                          <a href="/Movies/Details/${m.id}"
                             class="d-flex align-items-center p-2 text-decoration-none text-light border-bottom border-secondary">
                             ${m.poster ? `<img src="${m.poster}" class="me-2 rounded" width="32" height="48" />` : ''}
                             <span>${m.title}</span>
                          </a>
                        `).join('');
                        box.classList.remove('d-none');
                    } catch { box.classList.add('d-none'); box.innerHTML = ''; }
                }, 200);
            });

            document.addEventListener('click', (e) => {
                if (!box.contains(e.target) && e.target !== input) box.classList.add('d-none');
            });
        })();
    </script>

    @RenderSection("Scripts", required: false)
</body>
</html>